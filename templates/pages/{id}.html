<!DOCTYPE html>
<html>
{% set rows = sql("select * from museums where id = :id", {"id": id}) %}
{% if not rows %}
    {{ raise_404("Museum not found") }}
{% endif %}
{% set photos = sql("""
with urls as (select
  json_extract(j.value, '$.url') as url
from
  museums,
  json_each(photos) j
where
  museums.id = :id)
select url, width, height from photos where url in (select url from urls)
""", {"id": id}) %}
<head>
    <meta charset="utf-8">
    {% set museum = rows[0] %}
    {% set retina = 1 %}
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ museum.name }}</title>
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@nichemuseums">
    <meta name="twitter:creator" content="@simonw">
    <meta name="twitter:title" content="{{ museum.name }}">
    <meta name="twitter:description" content="{{ museum.description }}">
    <meta name="twitter:image" content="{{ museum.photo_url }}?w=1600&amp;h=800&amp;fit=crop&amp;auto=compress">
    <meta name="twitter:image:alt" content="{{ museum.photo_alt }}">
    <meta property="og:url" content="https://www.niche-museums.com/{{ museum.id }}">
    <meta property="og:type" content="article">
    <meta property="og:title" content="{{ museum.name }}">
    <meta property="og:description" content="{{ museum.description }}">
    <meta property="og:image" content="{{ museum.photo_url }}?w=1600&amp;h=800&amp;fit=crop&amp;auto=compress">
    <meta property="og:image:alt" content="{{ museum.photo_alt }}">
    <meta property="og:image:width" content="800">
    <meta property="og:image:height" content="400">
{% include "_analytics.html" %}
    <link rel="stylesheet" href="/static/museums.css">
    <link rel="stylesheet" href="/static/photoswipe.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="anonymous">
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin="anonymous"></script>
    <script src="/static/lazysizes.min.js" async></script>
    <script type="module">
    import PhotoSwipeLightbox from '/static/photoswipe-lightbox.esm.js';
    const lightbox = new PhotoSwipeLightbox({
        gallery: '#photos',
        children: '.gallery-photo',
        pswpModule: '/static/photoswipe.esm.js'
    });
    lightbox.init();
    </script>
</head>

<body>
    <nav class="navbar is-black" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="/">
                <strong>Niche Museums</strong>
            </a>
            <a class="navbar-item" href="/about">
                <span class="button is-small is-outlined is-white">About</span>
            </a>
        </div>
    </nav>
    <section class="section" id="cards">
        {% include "_museum_card.html" %}
    </section>
    {% if museum.press %}
    <section class="section articles" id="press">
        <div class="box content">
            {% for article in json.loads(museum.press) %}
            <h3 class="title is-5"><a href="{{ article.url }}">{{ article.title }}</a></h2>
                <p>{{ article.author }}, {{ article.publication }}, {{ nicer_date(article.date) }}</p>
                {% endfor %}
        </div>
    </section>
    {% endif %}
    {% if museum.photos %}
        <section class="section photos" id="photos">
            <div class="masonry">
            {% for photo in photos %}
                <a data-pswp-height="{{ photo.height }}" data-pswp-width="{{ photo.width }}" href="{{ photo.url }}?w=1200&auto=compress" class="gallery-photo"><img class="lazyload" src="{{ photo.url }}?w=400&blur=200&px=16&auto=format" data-src="{{ photo.url }}?w=400&auto=compress"{% if photo.alt %} alt="{{ photo.alt }}"{% endif %}></a>
            {% endfor %}
            </div>
        </section>
    {% endif %}
    <section class="section map-section">
        <div id="themap"></div>
    </section>
    <section class="section nearby-section">
        {% for museum in sql("""
            select *, haversine(latitude, longitude, :latitude, :longitude, 'mi') as distance_mi
            from museums
            where id != :id
            and permanently_closed is null order by distance_mi limit 3
        """, {
            "latitude": museum.latitude,
            "longitude": museum.longitude,
            "id": museum.id
        }) %}
        <div class="card box">
            <div class="content">
                {% if museum.photo_url %}
                <a href="/{{ museum.id }}"><img width="200" height="100" class="is-pulled-right" src="{{ museum.photo_url }}?w=400&amp;h=200&amp;fit=crop&amp;auto=compress" alt="{{ museum.photo_alt }}"></a>
                {% endif %}
                <h2><a href="/{{ museum.id }}">{{ museum.name }}</a></h2>
                <p class="distance-away">{{ museum.distance_mi|round(2) }} miles away</p>
            </div>
        </div>
        {% endfor %}
    </section>
    <style>
        .museum-label {
            background: white;
            border: 1px solid #666;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 12px;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .museum-label a {
            color: #333;
            text-decoration: none;
        }
        .museum-label a:hover {
            text-decoration: underline;
        }
        .current-museum-label {
            background: #3273dc;
            color: white;
            font-weight: bold;
        }
        .current-museum-label a {
            color: white;
        }
    </style>
    <script>
        const latitude = {{ museum.latitude }};
        const longitude = {{ museum.longitude }};
        const currentMuseumId = {{ museum.id }};

        document.addEventListener('DOMContentLoaded', () => {
            let el = document.querySelector('#themap');
            el.className = 'box';
            el.style.width = '100%';
            el.style.height = '500px';
            let latlng = L.latLng(latitude, longitude);
            let map = L.map(el, {
                center: latlng,
                zoom: {{ museum.map_zoom or "16" }}
            });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: "&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors"
            }).addTo(map);

            // Store markers so we can update them
            let markers = new Map();

            // Create a custom icon for the current museum
            const currentIcon = L.divIcon({
                className: 'current-museum-marker',
                html: '',
                iconSize: [25, 41],
                iconAnchor: [12, 41]
            });

            // Function to create a label marker
            function createLabelMarker(museum) {
                const isCurrentMuseum = museum.id === currentMuseumId;
                const labelClass = isCurrentMuseum ? 'museum-label current-museum-label' : 'museum-label';

                // Create the marker
                const marker = L.marker([museum.latitude, museum.longitude]);

                // Bind popup with museum name as link
                marker.bindPopup(`<a href="/${museum.id}"><strong>${museum.name}</strong></a>`);

                // Create a tooltip that shows the label
                marker.bindTooltip(
                    `<a href="/${museum.id}">${museum.name}</a>`,
                    {
                        permanent: true,
                        direction: 'right',
                        offset: [10, 0],
                        className: labelClass,
                        interactive: true
                    }
                );

                // Navigate on marker click
                marker.on('click', () => {
                    window.location.href = '/' + museum.id;
                });

                return marker;
            }

            // Function to fetch and display museums in the current bounds
            async function updateMarkers() {
                const bounds = map.getBounds();
                const params = new URLSearchParams({
                    south: bounds.getSouth(),
                    west: bounds.getWest(),
                    north: bounds.getNorth(),
                    east: bounds.getEast()
                });

                try {
                    const response = await fetch(`/bbox.json?${params}`);
                    const museums = await response.json();

                    // Track which museum IDs are in the new data
                    const newMuseumIds = new Set(museums.map(m => m.id));

                    // Remove markers that are no longer in bounds
                    for (const [id, marker] of markers) {
                        if (!newMuseumIds.has(id)) {
                            map.removeLayer(marker);
                            markers.delete(id);
                        }
                    }

                    // Add new markers
                    for (const museum of museums) {
                        if (!markers.has(museum.id)) {
                            const marker = createLabelMarker(museum);
                            marker.addTo(map);
                            markers.set(museum.id, marker);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching museums:', error);
                }
            }

            // Initial load of markers
            updateMarkers();

            // Update markers when map moves or zooms
            map.on('moveend', updateMarkers);
        });
    </script>
</body>

</html>